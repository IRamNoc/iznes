
node {
    timestamps {

        stage('Deploy Membership-db to Sales Environment') {

            sh 'ssh -t root@sales.iznes.io rm -f flyway \\&&'
            sh 'ssh -t root@sales.iznes.io ln -s /usr/local/bin/flyway-4.2.0/flyway /usr/local/bin/flyway \\&&'
            sh 'ssh -t root@sales.iznes.io rsync -avzh --stats /var/membership-db /var/ofi_backups/membership-db \\&&'
            sh 'rsync -avhm --stats /var/lib/jenkins/Deploy/membership-db/* root@sales.iznes.io:/var/membership-db'
            sh 'ssh -t root@sales.iznes.io \'cd /var/membership-db/deploy/ ./updatedb iznes\''

        }

        stage('Deploy Frontend to Sales Environment') {
            node {
                sh '''
              ssh root@sales.iznes.io rsync -avzh --stats /var/www_setltestnet/ /var/ofi_backups/www_setltestnet &&
              rsync -avhm --stats /var/lib/jenkins/Deploy/dist/*  root@sales.iznes.io:/var/www_setltestnet'''
            }
        }
        stage('Deploy Backend to Sales Environment') {
            node {
                sh '''
                            ssh root@sales.iznes.io rsync -avzhm --stats --exclude 'node_modules' /var/phpapps/backend/ /var/ofi_backups/backend &&
                            rsync -avhm --stats --exclude 'config.json' /var/lib/jenkins/Deploy/backend/* root@sales.iznes.io:/var/phpapps/backend'''
            }
        }

        stage('Deploy Daemon Node to Sales Environment') {

            sh '''
                            ssh root@sales.iznes.io rsync -avzhm --stats /var/phpapps/daemon-node /var/ofi_backups/daemon-node &&
                            rsync -avhm --stats --exclude \'.env\' /var/lib/jenkins/Deploy/daemon-node/* root@sales.iznes.io:/var/phpapps/daemon-node
                            ssh -t root@sales.iznes.io \'cd /var/phpapps/daemon-node ; bash && npm install \'                            
                            ssh -t root@sales.iznes.io \'cd /var/phpapps/daemon-node ; bash && npm run build \'                            
                            '''
        }

        stage('Update Dependencies') {
            sh 'ssh -t root@sales.iznes.io \'cd /var/phpapps/backend/ ; bash && npm install\''
        }

        stage('Update database') {
            sh 'ssh -tt root@sales.iznes.io \'cd /var/membership-db/deploy/ && ./updatedb iznes \''
        }


        stage('Deploy Blockchain jars to Test Environment') {

            sh '''
                        rsync -avhmp --stats /var/lib/jenkins/Deploy/blockchain/scripts/*  root@sales.iznes.io: &&
                        ssh -t root@sales.iznes.io \'cd /root ; bash &&  ./stop_blockchain.sh \'
                        ssh -t root@sales.iznes.io rm -f /usr/local/jar/*.jar &&
                        ssh -t root@sales.iznes.io rm -f /usr/local/jar/cmdtools &&
                        ssh -t root@sales.iznes.io rm -f /usr/local/jar/wallnode &&
                        ssh -t root@sales.iznes.io rm -f /usr/local/jar/valnode &&
                        rsync -avhm --stats /var/lib/jenkins/Deploy/blockchain/*.jar  root@sales.iznes.io:/usr/local/jar &&
                        ssh -t root@sales.iznes.io \'cd /root ; bash && ./relink.sh \' &&
                        ssh -t root@sales.iznes.io \'cd /root ; bash && ./start_blockchain.sh \''''

        }


        stage('Restart Node Server') {
            sh 'ssh -t root@sales.iznes.io \'cd /var/phpapps ; bash &&  supervisorctl restart node_server\''
        }


        stage('Check node server is running') {
            sh 'ssh -t root@sales.iznes.io \'cd /var/phpapps/backend/ ; bash && node checkServer.js\''
        }

    }
}



