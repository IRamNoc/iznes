node {

    timestamps {

        stage('Establish Tunnel Connection') {
            try{
                sh '''
                ssh -N -L localhost:9998:localhost:3306 root@139.162.213.130 &
                '''
            }catch (err) {
                throw err
            }
        }

        stage('Check Out Tests') {
            checkout([$class                           : 'GitSCM', branches: [[name: '*/master']],
                      doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [],
                      userRemoteConfigs                : [[credentialsId: '294d9ac9-499b-487d-8c4c-ba53c0cb56a7',
                                                           url          : 'git@si-nexus01.dev.setl.io:opencsd-rewrite/opencsd-frontend-clarity.git']]])
        }

        stage('Run Acceptance Tests') {
            try{
                sh '''rm -f target/test-attachments/*.jpg &&
                    cd ~/workspace/IZNESUITestsJ03/javaUITesting2 &&
                    cp /tmp/build.gradle . &&
                    export DISPLAY=:10
                    ./gradlew clean build -x test --parallel && ./gradlew build'''


            } catch (err) {
                if (currentBuild.result == 'UNSTABLE')
                    currentBuild.result = 'FAILURE'
                throw err
            } finally {
                archiveArtifacts allowEmptyArchive: true, artifacts: '**/target/test-attachments/*.jpg'

                junit allowEmptyResults: true, keepLongStdio: true,
                    testResults: '**/build/test-results/test/TEST-com**'
            }
        }

    }
}
