<div class="header-breadcrumbs">
    <h1 mltag="txt_contracts"><i class="fa fa-book"></i>Contracts &raquo; Manage</h1>
</div>

<clr-tabs *ngIf="tabs.length">
    <clr-tab *ngFor="let tab of tabs; let id = index">
        <button clrTabLink id="tablink{{id}}" [innerHTML]="tab.title"></button>
        <clr-tab-content *clrIfActive="tab.active">
            <section>
                <ng-container *ngIf="id === 0">
                    <ng-container *ngTemplateOutlet="contractsListTab"></ng-container>
                </ng-container>
                <ng-container *ngIf="id >= 1">
                    <ng-container *ngTemplateOutlet="dynamicViewTab; context: {'formControl': tab.formControl, 'id': id, 'contractFields': contractFields, 'contract': tab.data.contract, 'template': tab.data.template}"></ng-container>
                </ng-container>
            </section>
        </clr-tab-content>
    </clr-tab>
</clr-tabs>

<!-- User Data Table. -->
<ng-template #contractsListTab>
    <div class="panel-body">
        <clr-datagrid #contractsDataGrid>
            <clr-dg-column mltag="txt_contract_name" clrDgSortIcon>Contract Name</clr-dg-column>
            <clr-dg-column mltag="txt_creator" clrDgSortIcon>Creator</clr-dg-column>
            <clr-dg-column mltag="txt_expiry" clrDgSortIcon>Expiry</clr-dg-column>
            <clr-dg-column mltag="txt_status" clrDgSortIcon>Status</clr-dg-column>
            <clr-dg-column class="right" mltag="txt_actions" clrDgSortIcon>Actions</clr-dg-column>
            <clr-dg-row *clrDgItems="let contract of contracts; let i = index">
                <clr-dg-cell><span id="contract-{{contract.index}}"><span mltag="txt_contract">Contract</span> {{contract.name}}</span></clr-dg-cell>
                <clr-dg-cell>{{contract.issuingaddress_label}}</clr-dg-cell>
                <clr-dg-cell>{{contract.expiry * 1000 | date:'dd MMM yyyy H:mm:ss'}}</clr-dg-cell>
                <clr-dg-cell>
                    <span *ngIf="contract.__completed == -1" class="label label-success" mltag="txt_enabled">Complete</span>
                    <span *ngIf="contract.__completed !== -1" class="label label-warning" mltag="txt_incomplete">Incomplete</span>
                </clr-dg-cell>
                <clr-dg-cell class="right">
                    <button id="edit-{{contract.address}}" (click)="handleView(contract)" class="btn btn-orange btn-sm">
                        <i class="fa fa-search"></i>&nbsp;<span mltag="txt_view">View</span>
                    </button>
                </clr-dg-cell>
            </clr-dg-row>
            <clr-dg-footer>
                {{pagination.firstItem + 1}} - {{pagination.lastItem + 1}}
                <clr-dg-pagination #pagination [clrDgPageSize]="10"></clr-dg-pagination>
            </clr-dg-footer>
        </clr-datagrid>
    </div>
</ng-template>

<ng-template #dynamicViewTab let-formControl="formControl" let-id="id" let-contract="contract" let-template="template">
    <div class="panel-body">
        <table style="width:100%">
            <tbody>
                <tr>
                    <td>
                        <div class="header-breadcrumbs">
                            <h1 mltag="txt_contract"><i class="fa fa-book"></i>Contract</h1>
                        </div>
                    </td>
                    <td>
                        <div class="form-group tx-view-header" style="float:right">
                            <span *ngIf="contract.__completed == -1" class="label label-success" style="font-size:16px" mltag="txt_enabled">Complete</span>
                            <span *ngIf="contract.__completed != -1" class="label label-warning" style="font-size:16px" mltag="txt_incomplete">Incomplete</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <form>
            <section class="form-block">
                <label>Details</label>
                <div class="form-group">
                    <label for="startDate" mltag="txt_startdate">Start Date</label>
                    <input type="text" id="startDate" size="45" disabled value="{{contract.startdate * 1000|date:short}}">
                </div>
                <div class="form-group">
                    <label for="expiryDate" mltag="txt_expirydate">Expiry Date</label>
                    <input type="text" id="expiryDate"size="45" disabled value="{{contract.expiry * 1000|date:short}}">
                </div>
            </section>
        </form>
        <div *ngIf="contract.parties.length > 0">
            Parties
            <clr-datagrid #partiesDataGrid>
                <clr-dg-column mltag="txt_participant">Participant</clr-dg-column>
                <clr-dg-column mltag="txt_element">Element</clr-dg-column>
                <clr-dg-column mltag="txt_status">Status</clr-dg-column>
                <clr-dg-column class="right" mltag="txt_actions">Actions</clr-dg-column>
                <clr-dg-row *clrDgItems="let party of contract.parties; let i = index">
                    <clr-dg-cell>
                        <span><i class="fa fa-clock-o"></i> {{contract.status}}</span>
                    </clr-dg-cell>
                    <clr-dg-cell>{{party.sigAddress_label}}</clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="contract.payors[i] !== undefined" mltag="txt_pay">Pay</span> {{contract.payors[i]}}
                        <span *ngIf="contract.payors[i] !== undefined && contract.payees[i] !== undefined"> - </span>
                        <span *ngIf="contract.payees[i] !== undefined" mltag="txt_receive">Receive</span> {{contract.payees[i]}}
                    </clr-dg-cell>
                    <clr-dg-cell class="right">
                        <span *ngIf="party.signature != ''" class="label label-success"><i class="fa fa-check"></i>&nbsp;Committed</span>
                        <span *ngIf="party.signature == '' && party.sigAddress_label == party.sigAddress" class="label label-info"><i class="fa fa-clock-o"></i>&nbsp;Not Committed</span>
                        <span *ngIf="party.signature == '' && party.sigAddress_label != party.sigAddress">
                            <button id="edit-{{i}}" (click)="commitParty(i, contract)" class="btn btn-success btn-sm">
                                <i class="fa fa-check"></i>&nbsp;<span mltag="txt_view">Commit</span>
                            </button>
                        </span>
                    </clr-dg-cell>
                </clr-dg-row>
            </clr-datagrid>
        </div>
        <div *ngIf="contract.authorisations.length > 0">
            Authorisations
            <clr-datagrid #authorisationsDataGrid>
                <clr-dg-column mltag="txt_participant">Participant</clr-dg-column>
                <clr-dg-column mltag="txt_status">Status</clr-dg-column>
                <clr-dg-column class="right" mltag="txt_actions">Actions</clr-dg-column>
                <clr-dg-row *clrDgItems="let authorisation of contract.authorisations; let i = index">
                    <clr-dg-cell>
                        <span><i class="fa fa-clock-o"></i> {{contract.status}}</span>
                    </clr-dg-cell>
                    <clr-dg-cell>{{authorisation.sigAddress_label}}</clr-dg-cell>
                    <clr-dg-cell class="right">
                        <span *ngIf="authorisation.signature != ''" class="label label-success"><i class="fa fa-check"></i>&nbsp;Committed</span>
                        <span *ngIf="authorisation.signature == ''">
                            <button id="edit-{{i}}" (click)="commitAuthorisation(i, contract)" class="btn btn-success btn-sm">
                                <i class="fa fa-check"></i>&nbsp;<span mltag="txt_view">Commit</span>
                            </button>
                        </span>
                    </clr-dg-cell>
                </clr-dg-row>
            </clr-datagrid>
        </div>
        <div *ngIf="contract.addencumbrances.length > 0">
            Encumbrances
            <clr-datagrid #encumbrancesDataGrid>
                <clr-dg-column mltag="txt_parameter">Asset Id</clr-dg-column>
                <clr-dg-column mltag="txt_value">Amount</clr-dg-column>
                <clr-dg-row *clrDgItems="let encumbrance of contract.addencumbrances">
                    <clr-dg-cell>{{encumbrance.fullAssetId}}</clr-dg-cell>
                    <clr-dg-cell>{{encumbrance.amount}}</clr-dg-cell>
                </clr-dg-row>
            </clr-datagrid>
        </div>
        <div *ngIf="contract.parameters.length > 0">
            Parameters
            <clr-datagrid #parametersDataGrid>
                <clr-dg-column mltag="txt_parameter">Parameter</clr-dg-column>
                <clr-dg-column mltag="txt_value">Value</clr-dg-column>
                <clr-dg-row *clrDgItems="let parameter of contract.parameters">
                    <clr-dg-cell>{{parameter.key}}</clr-dg-cell>
                    <clr-dg-cell>{{parameter.value}}</clr-dg-cell>
                </clr-dg-row>
            </clr-datagrid>
        </div>
        <div class="form-group tx-view-header">
            <button type="button" class="btn btn-primary" (click)="closeTab(id)"><i class="fa fa-times"></i>&nbsp;Close</button>
        </div>
    </div>
</ng-template>