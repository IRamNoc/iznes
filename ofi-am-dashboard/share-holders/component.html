<div class="header-breadcrumbs">
    <h1><i class="fa fa-sitemap"></i>{{'Recordkeeping:' | translate}}</h1>
</div>

<section class="wrapper wrapper-content">
    <clr-tabs *ngIf="tabsControl.length">
        <clr-tab *ngFor="let tabdata of tabsControl">
            <button clrTabLink id="{{tabdata.id}}" [routerLink]="[tabdata.link, (tabdata.id === 0) ? 'list' :  tabdata.id]">
                <i class="fa {{tabdata.title.icon}}"></i> {{tabdata.title.text}} <span *ngIf="tabTitle !== '' && tabdata.type !== 'list'"> - {{tabTitle}}</span>
            </button>

            <clr-tab-content *clrIfActive="tabdata.active">

                <form [formGroup]="listSearchForm" id="search-list-orders-form" *ngIf="tabdata.type === 'list'">
                    <div class="form-horizontal">
                        <div class="row ">
                            <div class="form-group col-lg-4">
                                <div style="margin: 10px 0;">
                                    <b><span>{{'Search for a recordkeeping for a specific fund:' | translate}}</span></b>
                                </div>

                                <div class="input-button-group">
                                    <ng-select id="holders-list-funds-search-field" [items]="fundList" [allowClear]="true" [placeholder]="_translate.translate('Type a Fund name or a LEI code')" [formControl]="listSearchForm.controls['searchFunds']">
                                    </ng-select>
                                </div>
                            </div>
                            <div class="form-group col-lg-4">
                                <div style="margin: 10px 0;">
                                    <b><span>{{'Search for a recordkeeping for a specific share:' | translate}}</span></b>
                                </div>

                                <div class="input-button-group">
                                    <ng-select id="holders-list-shares-search-field" [items]="sharesList" [allowClear]="true" [placeholder]="_translate.translate('Type a Share name or an ISIN code')" [formControl]="listSearchForm.controls['searchShares']">
                                    </ng-select>
                                </div>
                            </div>
                            <div class="form-group col-lg-4">

                            </div>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
                </form>

                <form [formGroup]="searchForm" id="search-funds-orders-form" *ngIf="tabdata.type === 'funds'">
                    <div class="form-horizontal">
                        <div class="row ">
                            <div class="form-group col-lg-8">
                                <p>{{'Please select the fund on which you want to see the recordkeeping or export recordkeeping for all funds by clicking on the top right button.' | translate}}</p>
                                <div style="margin: 10px 0;">
                                    <b><span>{{'Fund Name:' | translate}}</span></b>
                                </div>

                                <div class="input-button-group">
                                    <ng-select id="holders-funds-search-field" [items]="fundList" [allowClear]="true" [placeholder]="_translate.translate('Type a Fund Name')" [formControl]="searchForm.controls['search']">
                                    </ng-select>
                                </div>
                            </div>
                            <div class="col-lg-4 text-right">
                                <button id="holders-funds-all-export-btn" type="button" class="btn btn-success" style="max-width: none !important" (click)="exportFile('funds', 0)">{{'Export Recordkeeping for all funds' | translate}}</button>
                            </div>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
                </form>

                <form [formGroup]="searchForm" id="search-shares-orders-form" *ngIf="tabdata.type === 'shares'">
                    <div class="form-horizontal">
                        <div class="row ">
                            <div class="form-group col-lg-8">
                                <p>{{'Please select the share on which you want to see the recordkeeping.' | translate}}</p>
                                <div style="margin: 10px 0;">
                                    <b><span>{{'Share Name or ISIN:' | translate}}</span></b>
                                </div>

                                <div class="input-button-group">
                                    <ng-select id="holders-shares-search-field" [items]="sharesList" [allowClear]="true" [placeholder]="_translate.translate('Type a Share Name or an ISIN code')" [formControl]="searchForm.controls['search']">
                                    </ng-select>
                                </div>
                            </div>
                            <div class="col-lg-4 text-right">
                                <button id="holders-shares-all-export-btn" type="button" class="btn btn-success" style="max-width: none !important" (click)="exportFile('shares', 0)">{{'Export Recordkeeping for all shares' | translate}}</button>
                            </div>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
                </form>

                <!--Holders list -->
                <ng-container *ngIf="tabdata.type === 'list'">
                    <ng-container *ngTemplateOutlet="staticAll"></ng-container>
                </ng-container>


                <!--Holders funds -->
                <ng-container *ngIf="tabdata.type === 'funds'">
                    <ng-container *ngTemplateOutlet="staticFunds"></ng-container>
                </ng-container>

                <!--Holders shares -->
                <ng-container *ngIf="tabdata.type === 'shares'">
                    <ng-container *ngTemplateOutlet="staticShares"></ng-container>
                </ng-container>

            </clr-tab-content>
        </clr-tab>
    </clr-tabs>

    <!-- Holders table -->
    <ng-template #staticAll>
        <div class="panel-body">
            <div class="row ">
                <div class="col-lg-8">
                    <h3 style="margin-bottom: 3px;">{{'Please find a list of all your products below:' | translate}}</h3>
                    {{'You can access the recordkeeping for a specific Fund or Share by clicking on the corresponding line in the datagrid below.' | translate}}
                </div>
                <div class="col-lg-4 text-right">
                    <button id="holders-export-list-btn1" type="button" class="btn btn-success" style="max-width: none !important" (click)="exportFile('funds', 0)">{{'Export recordkeeping for all Funds' | translate}}</button>
                    <br>
                    <button id="holders-export-list-btn2" type="button" class="btn btn-success" style="max-width: none !important" (click)="exportFile('shares', 0)">{{'Export recordkeeping for all Shares' | translate}}</button>
                </div>
            </div>
            <br>

            <clr-datagrid clrDgSortIcon #ordersDataGrid>
                <clr-dg-column>{{'Fund name' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'Share name' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'Currency' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'ISIN' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'NAV' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'Number of units' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'AUM' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'Ratio (%)' | translate}}

                </clr-dg-column>
                <clr-dg-column>{{'Number of holders' | translate}}

                </clr-dg-column>

                <clr-dg-row *clrDgItems="let data of allList" (click)="handleClickShare(data)" clrDgRowClickable>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col1">
                            {{data.fundName}}
                        </span>
                        <ng-template #col1>
                            <!--empty-->
                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col2">
                            <!--empty-->
                        </span>
                        <ng-template #col2>
                            {{data.shareName}}
                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col3">{{data.fundCurrency}}

                        </span>
                        <ng-template #col3>{{data.shareCurrency}}

                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col4">
                            <!--empty-->
                        </span>
                        <ng-template #col4>{{data.shareIsin}}

                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col5">
                            <!--empty-->
                        </span>
                        <ng-template #col5>{{data.shareNav | moneyValue: 2}}

                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col6">
                            <!--empty-->
                        </span>
                        <ng-template #col6>{{data.shareUnitNumber | moneyValue:4}}

                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col7">{{data.fundAum | moneyValue:5}}

                        </span>
                        <ng-template #col7>{{data.shareAum | moneyValue:5}}

                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col8">
                            <!--empty-->
                        </span>
                        <ng-template #col8>{{data.shareRatio | moneyValue:2}}{{'%' | translate}}

                        </ng-template>
                    </clr-dg-cell>
                    <clr-dg-cell>
                        <span *ngIf="data.isFund; else col9">{{data.fundHolderNumber}}

                        </span>
                        <ng-template #col9>{{data.shareHolderNumber}}

                        </ng-template>
                    </clr-dg-cell>
                </clr-dg-row>

                <clr-dg-footer>
                    <clr-dg-pagination #pagination [clrDgPageSize]="10">
                        <!--{{pagination.firstItem + 1}} - {{pagination.lastItem + 1}} of {{pagination.totalItems}}-->
                    </clr-dg-pagination>
                </clr-dg-footer>
            </clr-datagrid>
        </div>
    </ng-template>

    <ng-template #staticFunds>
        <div class="panel-body">
            <form [formGroup]="filtersForm" id="filters-funds-orders-form">
                <div class="form-horizontal">
                    <div class="row ">
                        <div class="form-group col-lg-4">
                            <label>
                                <b>{{'Top holders of this fund:' | translate}}</b>
                            </label>
                            <div class="input-button-group">
                                <ng-select id="holders-fund-filter-top" [items]="holderFilters" [allowClear]="true" [placeholder]="_translate.translate('Top holders of this fund')" [formControl]="filtersForm.controls['topholders']">
                                </ng-select>
                            </div>
                        </div>
                        <div class="form-group col-lg-4">
                            <label>
                                <b>{{'Last Settlement Date:' | translate}}</b>
                            </label>
                            <div>
                                <span class="readonly-field">{{fundSettlementDate}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="form-group col-lg-8">
                            <div class="form-group col-lg-4">
                                <label>
                                    <b>{{'Number of holders' | translate}}</b>
                                </label>
                                <div>
                                    <span class="readonly-field">{{fundsNbHolders}}</span>
                                </div>
                            </div>
                            <div class="form-group col-lg-4">
                                <label>
                                    <b>{{'Fund AUM' | translate}}</b>
                                </label>
                                <div>
                                    <span class="readonly-field">{{fundsAUM | moneyValue:5}}</span>
                                </div>
                            </div>
                            <div class="form-group col-lg-4">
                                <label>
                                    <b>{{'CCY' | translate}}</b>
                                </label>
                                <div>
                                    <span class="readonly-field">{{fundsCCY}}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 text-right">
                            <button id="holders-funds-export-btn" type="button" class="mt-1 btn btn-success" style="max-width: none !important" (click)="exportFile('funds', 1)">{{'Export @tabTitle@ Recordkeeping' | translate: {'tabTitle': tabTitle} }}</button>
                        </div>
                    </div>
                </div>
            </form>

            <br>

            <clr-datagrid clrDgSortIcon #ordersDataGrid>
                <clr-dg-column>{{'Ranking' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Investor' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Portfolio' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Asset (Fund CCY)' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Ratio (%)' | translate}}</clr-dg-column>

                <clr-dg-row *clrDgItems="let item of holdersFundData">
                    <clr-dg-cell>{{item.ranking}}</clr-dg-cell>
                    <clr-dg-cell>{{item.investorName}}</clr-dg-cell>
                    <clr-dg-cell>{{item.portfolio}}</clr-dg-cell>
                    <clr-dg-cell>{{item.amount | moneyValue:5}}</clr-dg-cell>
                    <clr-dg-cell>{{item.fundRatio | moneyValue:2}}{{'%' | translate}}</clr-dg-cell>
                </clr-dg-row>

                <clr-dg-footer>
                    <clr-dg-pagination #pagination [clrDgPageSize]="10">
                        <!--{{pagination.firstItem + 1}} - {{pagination.lastItem + 1}} of {{pagination.totalItems}}-->
                    </clr-dg-pagination>
                </clr-dg-footer>
            </clr-datagrid>
        </div>
    </ng-template>

    <ng-template #staticShares>
        <div class="panel-body">
            <form [formGroup]="filtersForm" id="filters-shares-orders-form">
                <div class="form-horizontal">
                    <div class="row ">
                        <div class="col-lg-8">
                            <div class="row">
                                <div class="form-group col-lg-6">
                                    <label>
                                        <b>{{'Top holders of this share:' | translate}}</b>
                                    </label>
                                    <div class="input-button-group">
                                        <ng-select id="holders-shares-filter-top" [items]="holderFilters" [allowClear]="true" [placeholder]="_translate.translate('Top holders of this share')" [formControl]="filtersForm.controls['topholders']">
                                        </ng-select>
                                    </div>
                                </div>
                                <div class="form-group col-lg-6">
                                    <label>
                                        <b>{{'Last Settlement Date:' | translate}}</b>
                                    </label>
                                    <div>
                                        <span class="readonly-field">{{shareSettlementDate}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 text-right">
                            <button id="holders-shares-export-btn" type="button" class="mt-1 btn btn-success" style="max-width: none !important" (click)="exportFile('shares', 1)">{{'Export @tabTitle@ Recordkeeping' | translate: {'tabTitle': tabTitle} }}</button>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="form-group col-lg-2">
                            <label>
                                <b>{{'Number of holders' | translate}}</b>
                            </label>
                            <div>
                                <span class="readonly-field">{{sharesNbHolders}}</span>
                            </div>
                        </div>
                        <div class="form-group col-lg-3">
                            <label>
                                <b>{{'Share AUM' | translate}}</b>
                            </label>
                            <div>
                                <span class="readonly-field">{{sharesAUM | moneyValue:5}}</span>
                            </div>
                        </div>
                        <div class="form-group col-lg-2">
                            <label>
                                <b>{{'Number of units' | translate}}</b>
                            </label>
                            <div>
                                <span class="readonly-field">{{sharesNbUnits | moneyValue:5}}</span>
                            </div>
                        </div>
                        <div class="form-group col-lg-3">
                            <label>
                                <b>{{'Latest NAV' | translate}}</b>
                            </label>
                            <div>
                                <span class="readonly-field">{{sharesLatestNAV | moneyValue:2}}</span>
                            </div>
                        </div>
                        <div class="form-group col-lg-2">
                            <label>
                                <b>{{'CCY' | translate}}</b>
                            </label>
                            <div>
                                <span class="readonly-field">{{sharesCCY}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <br>

            <clr-datagrid clrDgSortIcon #ordersDataGrid>
                <clr-dg-column>{{'Ranking' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Investor' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Portfolio' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Quantity' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Asset (Fund CCY)' | translate}}</clr-dg-column>
                <clr-dg-column>{{'Ratio (%)' | translate}}</clr-dg-column>

                <clr-dg-row *clrDgItems="let item of holdersShareData">
                    <clr-dg-cell>{{item.ranking}}</clr-dg-cell>
                    <clr-dg-cell>{{item.companyName}}</clr-dg-cell>
                    <clr-dg-cell>{{item.investorName}}</clr-dg-cell>
                    <clr-dg-cell>{{item.quantity | moneyValue:4}}</clr-dg-cell>
                    <clr-dg-cell>{{item.amount | moneyValue:5}}</clr-dg-cell>
                    <clr-dg-cell>{{item.ratio | moneyValue:2}}{{'%' | translate}}</clr-dg-cell>
                </clr-dg-row>

                <clr-dg-footer>
                    <clr-dg-pagination #pagination [clrDgPageSize]="10">
                        <!--{{pagination.firstItem + 1}} - {{pagination.lastItem + 1}} of {{pagination.totalItems}}-->
                    </clr-dg-pagination>
                </clr-dg-footer>
            </clr-datagrid>
        </div>
    </ng-template>

</section>

<!-- NAV upload modal -->
<clr-modal [(clrModalOpen)]="showModal" [clrModalClosable]="true">
    <!--*ngIf="isFundLevel"-->
    <h3 class="modal-title">
        {{'Export Recorkeeping with share details?' | translate}}
    </h3>

    <div class="modal-body text-center">
        <p *ngIf="gotDataToExport">
            {{'Do you want to export the record keeping at funds level only,' | translate}}
            <br>
            {{'or do you want shares details too?' | translate}}
        </p>
        <p *ngIf="!gotDataToExport">
            {{'You must first select a fund.' | translate}}
        </p>
    </div>

    <div class="modal-footer">
        <button id='exportFundOnly' type="button" class="btn btn-primary mr-1" [disabled]="!gotDataToExport" (click)="exportFile('funds', 0)">{{'Export at funds level only' | translate}}</button>
        <button id='exportFundShares' type="button" class="btn btn-primary" [disabled]="!gotDataToExport" (click)="exportFile('shares', 0)">{{'Export with shares details' | translate}}</button>
    </div>
</clr-modal>
